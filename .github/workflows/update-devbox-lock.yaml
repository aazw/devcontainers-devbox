name: Update devbox.lock

on:
  pull_request:
    paths:
      - "images/*/devbox.json"
      - ".devcontainer/devbox.json"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lock:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout PR branch
        # uses: actions/checkout@v6
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false

      - name: Create dummy devbox.json for installation
        run: |
          mkdir -p /tmp/devbox-dummy
          cat > /tmp/devbox-dummy/devbox.json << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.16.0/.schema/devbox.schema.json",
            "packages": []
          }
          EOF

      - name: Install devbox
        # uses: jetify-com/devbox-install-action@v0.14.0
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          project-path: /tmp/devbox-dummy

      - name: Detect changed devbox.json files
        id: detect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # PR„ÅßÂ§âÊõ¥„Åï„Çå„Åüdevbox.json„Éï„Ç°„Ç§„É´„ÇíÂèñÂæó
          CHANGED_FILES=$(gh pr view "${PR_NUMBER}" --json files -q '.files[].path' | grep 'devbox.json$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No devbox.json files changed"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed devbox.json files:"
          echo "$CHANGED_FILES"

          # ÊîπË°åÂå∫Âàá„Çä„ÇíJSONÈÖçÂàó„Å´Â§âÊèõ
          DIRS=$(echo "$CHANGED_FILES" | xargs -I {} dirname {} | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "dirs=$DIRS" >> "$GITHUB_OUTPUT"
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Update devbox.lock files
        if: steps.detect.outputs.changed == 'true'
        id: update
        env:
          DIRS: ${{ steps.detect.outputs.dirs }}
        run: |
          UPDATED_FILES=""

          while IFS= read -r DIR; do
            echo "Updating devbox.lock in $DIR"

            # devbox.lock „ÇíÊõ¥Êñ∞
            devbox install --config "$DIR"

            # devbox.lock „ÅåÊñ∞Ë¶è‰ΩúÊàê„Åæ„Åü„ÅØÂ§âÊõ¥„Åï„Çå„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if git ls-files --error-unmatch "$DIR/devbox.lock" > /dev/null 2>&1; then
              # Êó¢Â≠ò„Éï„Ç°„Ç§„É´: Â§âÊõ¥„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
              if git diff --quiet "$DIR/devbox.lock"; then
                echo "No changes in $DIR/devbox.lock"
              else
                echo "Updated $DIR/devbox.lock"
                UPDATED_FILES="$UPDATED_FILES $DIR/devbox.lock"
              fi
            else
              # Êñ∞Ë¶è„Éï„Ç°„Ç§„É´
              echo "Created $DIR/devbox.lock"
              UPDATED_FILES="$UPDATED_FILES $DIR/devbox.lock"
            fi
          done < <(echo "$DIRS" | jq -r '.[]')

          if [ -z "$UPDATED_FILES" ]; then
            echo "No lock files were updated"
            echo "updated=false" >> "$GITHUB_OUTPUT"
          else
            echo "Updated lock files:$UPDATED_FILES"
            echo "updated=true" >> "$GITHUB_OUTPUT"
            echo "files=$UPDATED_FILES" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push changes
        if: steps.update.outputs.updated == 'true'
        env:
          UPDATED_FILES: ${{ steps.update.outputs.files }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          read -r -a files <<<"${UPDATED_FILES}"
          git add -- "${files[@]}"
          git commit -m "chore: update devbox.lock files

          ü§ñ Generated with GitHub Actions"

          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          BASIC_AUTH="$(printf 'x-access-token:%s' "${GH_TOKEN}" | base64 | tr -d '\n')"
          git -c http.https://github.com/.extraheader="AUTHORIZATION: basic ${BASIC_AUTH}" push origin "HEAD:${BRANCH}"
