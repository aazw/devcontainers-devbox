name: Update devbox.lock

on:
  pull_request:
    paths:
      - "images/*/devbox.json"
      - ".devcontainer/devbox.json"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lock:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create dummy devbox.json for installation
        run: |
          mkdir -p /tmp/devbox-dummy
          cat > /tmp/devbox-dummy/devbox.json << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.16.0/.schema/devbox.schema.json",
            "packages": []
          }
          EOF

      - name: Install devbox
        uses: jetify-com/devbox-install-action@v0.14.0
        with:
          project-path: /tmp/devbox-dummy

      - name: Detect changed devbox.json files
        id: detect
        run: |
          # PRã§å¤‰æ›´ã•ã‚ŒãŸdevbox.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path' | grep 'devbox.json$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No devbox.json files changed"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed devbox.json files:"
          echo "$CHANGED_FILES"

          # æ”¹è¡ŒåŒºåˆ‡ã‚Šã‚’JSONé…åˆ—ã«å¤‰æ›
          DIRS=$(echo "$CHANGED_FILES" | xargs -I {} dirname {} | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "dirs=$DIRS" >> "$GITHUB_OUTPUT"
          echo "changed=true" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update devbox.lock files
        if: steps.detect.outputs.changed == 'true'
        id: update
        run: |
          DIRS='${{ steps.detect.outputs.dirs }}'
          UPDATED_FILES=""

          for DIR in $(echo "$DIRS" | jq -r '.[]'); do
            echo "Updating devbox.lock in $DIR"

            # devbox.lock ã‚’æ›´æ–°
            devbox install --config "$DIR"

            # devbox.lock ãŒæ–°è¦ä½œæˆã¾ãŸã¯å¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
            if git ls-files --error-unmatch "$DIR/devbox.lock" > /dev/null 2>&1; then
              # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«: å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if git diff --quiet "$DIR/devbox.lock"; then
                echo "No changes in $DIR/devbox.lock"
              else
                echo "Updated $DIR/devbox.lock"
                UPDATED_FILES="$UPDATED_FILES $DIR/devbox.lock"
              fi
            else
              # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«
              echo "Created $DIR/devbox.lock"
              UPDATED_FILES="$UPDATED_FILES $DIR/devbox.lock"
            fi
          done

          if [ -z "$UPDATED_FILES" ]; then
            echo "No lock files were updated"
            echo "updated=false" >> "$GITHUB_OUTPUT"
          else
            echo "Updated lock files:$UPDATED_FILES"
            echo "updated=true" >> "$GITHUB_OUTPUT"
            echo "files=$UPDATED_FILES" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push changes
        if: steps.update.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add ${{ steps.update.outputs.files }}
          git commit -m "chore: update devbox.lock files

          ðŸ¤– Generated with GitHub Actions"

          git push
